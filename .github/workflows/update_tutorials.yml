name: Update Tutorial Outputs

on:
  # Run monthly on the 1st at 00:00 UTC
  schedule:
    - cron: '0 0 1 * *'
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      tutorial_name:
        description: 'Specific tutorial to run (e.g., closed_loop_botorch_only.ipynb). Leave empty to run all.'
        required: false
        type: string
      create_pr:
        description: 'Create a PR with the updated outputs'
        required: false
        type: boolean
        default: true

jobs:
  update-tutorials:
    name: Update tutorial outputs
    runs-on: ubuntu-latest
    env:
      UV_SYSTEM_PYTHON: 1
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Fetch all history for all tags and branches
      run: git fetch --prune --unshallow || true

    - name: Install latest PyTorch & GPyTorch
      run: |
        uv pip install --pre torch torchvision --index-url https://download.pytorch.org/whl/nightly/cpu
        uv pip install git+https://github.com/cornellius-gp/linear_operator.git
        uv pip install git+https://github.com/cornellius-gp/gpytorch.git

    - name: Install BoTorch with tutorials dependencies
      run: |
        uv pip install .[tutorials]

    - name: Run tutorials and update outputs
      run: |
        name_option=""
        if [ -n "${{ inputs.tutorial_name }}" ]; then
          name_option="-n ${{ inputs.tutorial_name }}"
        fi
        python scripts/run_tutorials.py -p "$(pwd)" $name_option --save-outputs

    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet tutorials/; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.check_changes.outputs.has_changes == 'true' && (inputs.create_pr == true || github.event_name == 'schedule')
      env:
        # github.token is automatically generated by GitHub Actions for each workflow run
        GH_TOKEN: ${{ github.token }}
      run: |
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Create branch and commit changes
        BRANCH_NAME="update-tutorial-outputs"
        git checkout -b "$BRANCH_NAME"
        git add tutorials/
        git commit -m "Update tutorial outputs"

        # Push branch (force push to update if branch exists)
        git push -f origin "$BRANCH_NAME"

        # Check if PR already exists
        EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
        if [ -n "$EXISTING_PR" ]; then
          echo "PR #$EXISTING_PR already exists, it has been updated with the latest changes."
        else
          # Create PR using GitHub CLI
          gh pr create \
            --title "[bot] Update tutorial outputs" \
            --body "This PR updates tutorial outputs to keep the website documentation current.

        This PR was automatically generated by the monthly tutorial update workflow.

        Please review the changes to ensure the tutorials executed correctly." \
            --label "documentation"
        fi
